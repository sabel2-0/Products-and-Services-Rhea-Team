@{
    ViewData["Title"] = "Product Detail";
    var productId = ViewData["ProductId"];
}

<div class="product-page" id="product-page">
    <!-- Back / Breadcrumb -->
    <div class="product-page-breadcrumb">
        <div class="container">
            <a href="/Home/Shop" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Back to Shop
            </a>
            <span class="breadcrumb-sep">/</span>
            <span id="breadcrumb-name" class="breadcrumb-current"></span>
        </div>
    </div>

    <!-- Loading State -->
    <div class="product-page-loading" id="product-loading">
        <div class="loading-spinner"></div>
        <p>Loading product…</p>
    </div>

    <!-- Product Content -->
    <div class="product-page-content container" id="product-content" style="display:none;">
        <div class="product-page-body">
            <!-- Gallery Column -->
            <div class="product-page-gallery">
                <div class="page-gallery-thumbs" id="page-gallery-thumbs"></div>
                <div class="page-gallery-main">
                    <img id="page-product-image" src="" alt="" />
                </div>
            </div>

            <!-- Info Column -->
            <div class="product-page-info">
                <div class="pd-brand" id="pd-brand"></div>
                <h1 class="pd-name" id="pd-name"></h1>
                <div class="pd-rating" id="pd-rating"></div>
                <div class="pd-price" id="pd-price"></div>
                <p class="pd-description" id="pd-description"></p>

                <!-- Colors -->
                <div class="pd-option-section" id="pd-color-section" style="display:none;">
                    <label class="pd-option-label">Color</label>
                    <div class="pd-color-options" id="pd-color-options"></div>
                </div>

                <!-- Sizes -->
                <div class="pd-option-section">
                    <label class="pd-option-label">Size</label>
                    <div class="pd-size-options" id="pd-size-options"></div>
                </div>

                <!-- Quantity -->
                <div class="pd-option-section">
                    <label class="pd-option-label">Quantity</label>
                    <div class="pd-quantity-control">
                        <button class="pd-qty-btn" onclick="changeQty(-1)">−</button>
                        <span class="pd-qty-value" id="pd-qty">1</span>
                        <button class="pd-qty-btn" onclick="changeQty(1)">+</button>
                    </div>
                </div>

                <!-- Stock -->
                <div class="pd-stock-display" id="pd-stock-display"></div>

                <!-- Action Buttons -->
                <div class="pd-actions">
                    <button class="pd-btn-cart" onclick="pdAddToCart()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                        Add to Cart
                    </button>
                    <button class="pd-btn-buy" onclick="pdBuyNow()">Buy Now</button>
                    <button class="pd-btn-wishlist" onclick="pdToggleWishlist()" id="pd-wishlist-btn" title="Add to Wishlist">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </button>
                    <button class="pd-btn-share" onclick="pdShare()" title="Share">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <circle cx="18" cy="19" r="3"></circle>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                        </svg>
                    </button>
                </div>

                <!-- Tags / Meta -->
                <div class="pd-meta" id="pd-meta"></div>
            </div>
        </div>

        <!-- Customer Reviews — directly beneath product info, clearly belongs to this product -->
        <div class="pd-reviews-section">
            <div class="pd-reviews-header">
                <div>
                    <h2>Customer Reviews</h2>
                    <span class="pd-reviews-summary" id="pd-reviews-summary"></span>
                </div>
                <button class="pd-view-all-btn" onclick="openReviewsModal()" id="pd-view-all-btn" style="display:none;">View All Reviews</button>
            </div>
            <div class="pd-reviews-grid" id="pd-reviews-grid"></div>
        </div>

        <!-- You May Also Like — clearly a separate full-width section -->
        <div class="you-may-also-like pd-related-full" id="pd-related-section">
            <h2 class="related-title">You May Also Like</h2>
            <div class="related-grid related-grid-row" id="pd-related-grid"></div>
        </div>

    </div>

    <!-- Reviews Full Modal -->
    <div id="reviews-modal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content reviews-modal-content">
            <div class="modal-header">
                <h2>All Reviews</h2>
                <button class="close-btn" onclick="closeReviewsModal()">&times;</button>
            </div>
            <div class="reviews-modal-body">
                <div class="reviews-grid" id="all-reviews-grid"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
const PRODUCT_ID = @productId;
let pdProduct = null;
let pdSelectedSize = null;
let pdSelectedColor = null;
let pdQty = 1;
let pdMaxStock = 0;

document.addEventListener('DOMContentLoaded', function() {
    loadProductPage(PRODUCT_ID);
});

async function loadProductPage(id) {
    try {
        const res = await fetch(`/api/products/${id}`);
        if (!res.ok) throw new Error('Not found');
        pdProduct = await res.json();
        renderProductPage();
        loadRelated();
        checkWishlistState();
    } catch (e) {
        document.getElementById('product-loading').innerHTML = '<p style="color:#888;text-align:center;padding:4rem;">Product not found. <a href="/Home/Shop">Back to Shop</a></p>';
    }
}

function renderProductPage() {
    document.getElementById('product-loading').style.display = 'none';
    document.getElementById('product-content').style.display = 'block';
    document.title = `${pdProduct.name} - NEXT HORIZON`;

    // Breadcrumb
    document.getElementById('breadcrumb-name').textContent = pdProduct.name;

    // Main image
    const img = document.getElementById('page-product-image');
    img.src = pdProduct.image;
    img.alt = pdProduct.name;
    img.onerror = function() { this.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='800'%3E%3Crect width='800' height='800' fill='%23fafafa'/%3E%3C/svg%3E"; };

    // Thumbnails
    const images = (pdProduct.images && pdProduct.images.length) ? pdProduct.images : [pdProduct.image];
    document.getElementById('page-gallery-thumbs').innerHTML = images.map((src, i) => `
        <div class="page-thumb ${i === 0 ? 'active' : ''}" onclick="changePageImage('${src}', this)">
            <img src="${src}" alt="View ${i+1}" onerror="this.parentElement.style.display='none'">
        </div>
    `).join('');

    document.getElementById('pd-brand').textContent = pdProduct.brand || '';
    document.getElementById('pd-name').textContent = pdProduct.name;
    document.getElementById('pd-price').textContent = formatPeso(pdProduct.price);
    document.getElementById('pd-description').textContent = pdProduct.description || '';

    document.getElementById('pd-rating').innerHTML = `
        <span class="stars">${getStars(pdProduct.rating)}</span>
        <span>${pdProduct.rating.toFixed(1)} (${pdProduct.reviewCount} reviews)</span>
    `;

    // Colors
    if (pdProduct.availableColors && pdProduct.availableColors.length > 0) {
        document.getElementById('pd-color-section').style.display = 'block';
        document.getElementById('pd-color-options').innerHTML = pdProduct.availableColors.map(c => `
            <div class="pd-color-opt" onclick="pdSelectColor('${c}', this)">${c}</div>
        `).join('');
    }

    // Sizes
    document.getElementById('pd-size-options').innerHTML = pdProduct.sizes.map(s => `
        <div class="pd-size-opt" onclick="pdSelectSize('${s}', this)">${s}</div>
    `).join('');

    // Meta
    document.getElementById('pd-meta').innerHTML = `
        <span class="pd-meta-tag">${pdProduct.category || ''}</span>
        ${pdProduct.subCategory ? `<span class="pd-meta-tag">${pdProduct.subCategory}</span>` : ''}
    `;

    // Stock
    pdMaxStock = pdProduct.stock || 0;
    const stockEl = document.getElementById('pd-stock-display');
    if (pdMaxStock === 0) {
        stockEl.innerHTML = '<span class="pd-stock-badge out">Out of Stock</span>';
        document.querySelector('.pd-btn-cart').disabled = true;
        document.querySelector('.pd-btn-buy').disabled = true;
    } else if (pdMaxStock <= 5) {
        stockEl.innerHTML = `<span class="pd-stock-badge low">Low Stock — Only ${pdMaxStock} left</span>`;
    } else {
        stockEl.innerHTML = `<span class="pd-stock-badge in">In Stock (${pdMaxStock} available)</span>`;
    }

    // Reviews
    if (pdProduct.reviews && pdProduct.reviews.length > 0) {
        document.getElementById('pd-reviews-summary').textContent = `${pdProduct.rating.toFixed(1)} / 5.0 · ${pdProduct.reviewCount} reviews`;
        document.getElementById('pd-reviews-grid').innerHTML = pdProduct.reviews.slice(0, 3).map(r => `
            <div class="pd-review-card">
                <div class="pd-review-top">
                    <span class="pd-review-name">${r.userName}</span>
                    <span class="stars">${getStars(r.rating)}</span>
                    ${r.verifiedPurchase ? '<span class="pd-verified">✓ Verified</span>' : ''}
                </div>
                <p class="pd-review-comment">${r.comment}</p>
                <span class="pd-review-date">${new Date(r.date).toLocaleDateString('en-PH')}</span>
            </div>
        `).join('');
        if (pdProduct.reviews.length > 3) {
            document.getElementById('pd-view-all-btn').style.display = 'inline-flex';
        }
    } else {
        document.getElementById('pd-reviews-grid').innerHTML = '<p class="pd-no-reviews">No reviews yet.</p>';
    }
}

function changePageImage(src, el) {
    document.getElementById('page-product-image').src = src;
    document.querySelectorAll('.page-thumb').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
}

function pdSelectSize(size, el) {
    pdSelectedSize = size;
    document.querySelectorAll('.pd-size-opt').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
}

function pdSelectColor(color, el) {
    pdSelectedColor = color;
    document.querySelectorAll('.pd-color-opt').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
}

function changeQty(delta) {
    const max = pdMaxStock > 0 ? pdMaxStock : 99;
    pdQty = Math.max(1, Math.min(max, pdQty + delta));
    document.getElementById('pd-qty').textContent = pdQty;
    // Dim the + button when at max
    document.querySelectorAll('.pd-qty-btn')[1].style.opacity = pdQty >= max ? '0.35' : '1';
    document.querySelectorAll('.pd-qty-btn')[1].style.pointerEvents = pdQty >= max ? 'none' : 'auto';
}

async function pdAddToCart() {
    if (!pdSelectedSize) { toast.info('Please select a size first'); return; }
    const btn = document.querySelector('.pd-btn-cart');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg> Added!';
    btn.classList.add('pd-btn-added');
    try {
        await fetch('/api/cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId: pdProduct.id, size: pdSelectedSize, quantity: pdQty })
        });
        toast.success(`${pdProduct.name} added to cart!`);
        updateCartCount();
    } catch (e) {
        toast.info('Could not add to cart. Try again.');
    }
    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('pd-btn-added');
        btn.disabled = false;
    }, 2000);
}

function pdBuyNow() {
    if (!pdSelectedSize) { toast.info('Please select a size'); return; }
    pdAddToCart().then(() => { window.location.href = '/Home/Shop'; });
}

async function pdToggleWishlist() {
    const btn = document.getElementById('pd-wishlist-btn');
    const isActive = btn.classList.contains('active');
    try {
        if (isActive) {
            await fetch(`/api/wishlist/${pdProduct.id}`, { method: 'DELETE' });
            btn.classList.remove('active');
            toast.info('Removed from wishlist');
        } else {
            await fetch(`/api/wishlist/${pdProduct.id}`, { method: 'POST' });
            btn.classList.add('active');
            toast.success('Added to wishlist!');
        }
        updateWishlistCount();
    } catch (e) { toast.info('Could not update wishlist.'); }
}

async function checkWishlistState() {
    try {
        const res = await fetch('/api/wishlist');
        const items = await res.json();
        if (pdProduct && items.some(i => i.wishlistItem && i.wishlistItem.productId === pdProduct.id)) {
            document.getElementById('pd-wishlist-btn')?.classList.add('active');
        }
    } catch(e) {}
}

function pdShare() {
    const url = window.location.href;
    if (navigator.share) {
        navigator.share({ title: pdProduct.name, text: pdProduct.description, url });
    } else {
        navigator.clipboard.writeText(url).then(() => toast.success('Link copied to clipboard!'));
    }
}

async function loadRelated() {
    try {
        const res = await fetch('/api/products');
        const all = await res.json();
        const related = all.filter(p => p.id !== pdProduct.id && p.category === pdProduct.category).slice(0, 4);
        const grid = document.getElementById('pd-related-grid');
        if (related.length === 0) {
            grid.innerHTML = '<p class="pd-no-reviews">No related products found.</p>';
            return;
        }
        grid.innerHTML = related.map(p => `
            <div class="related-card" onclick="window.location.href='/Home/Product?id=${p.id}'">
                <div class="related-card-image">
                    <img src="${p.image}" alt="${p.name}" loading="lazy"
                        onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27300%27%3E%3Crect width=%27300%27 height=%27300%27 fill=%27%23fafafa%27/%3E%3C/svg%3E'">
                    <div class="related-card-overlay">View</div>
                </div>
                <div class="related-card-info">
                    <div class="related-card-name">${p.name}</div>
                    <div class="related-card-price">${formatPeso(p.price)}</div>
                </div>
            </div>
        `).join('');
    } catch(e) {}
}

function openReviewsModal() {
    if (!pdProduct || !pdProduct.reviews || pdProduct.reviews.length === 0) return;
    document.getElementById('all-reviews-grid').innerHTML = pdProduct.reviews.map(r => `
        <div class="review-item">
            <div class="review-header">
                <span class="review-name">${r.userName}</span>
                <span class="review-date">${new Date(r.date).toLocaleDateString('en-PH')}</span>
            </div>
            <div class="review-stars"><span class="stars">${getStars(r.rating)}</span>
                ${r.verifiedPurchase ? '<span class="pd-verified">✓ Verified</span>' : ''}
            </div>
            <p class="review-comment-text">${r.comment}</p>
        </div>
    `).join('');
    document.getElementById('reviews-modal').classList.add('active');
    document.body.classList.add('modal-open');
}

function closeReviewsModal() {
    document.getElementById('reviews-modal').classList.remove('active');
    document.body.classList.remove('modal-open');
}
</script>
}
